<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Consultas Presidenciales – Ejercicio pedagógico</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Encabezado: recuadro azul -->
  <header class="banner banner--contained" role="banner" aria-label="Consultas Presidenciales">
    <div class="container">
      <div class="banner__content">
        <h1 class="banner__title">Consultas Presidenciales</h1>
      </div>
    </div>
  </header>

  <!-- Recuadro amarillo con instructivo -->
  <section class="note note--warning" aria-label="Instructivo pedagógico">
    <div class="container">
      <div class="note__content">
        <span class="note__badge">Instructivo</span>
        <p class="note__text">
          Este es un instructivo pedagógico sobre cómo votar en las consultas de 8 de marzo,
          recuerda que debes marcar un único candidato, <strong>marcar más de uno anula tu voto</strong>.
        </p>
      </div>
    </div>
  </section>

  <main class="container">
    <div id="content"></div>

    <!-- Resultados por consulta (SIEMPRE visibles, SOLO %) -->
    <section class="results">
      <h3>Resultados globales por consulta (en tiempo real)</h3>
      <p class="muted">Los porcentajes corresponden a la proporción de votos globales de cada consulta. También verás los dos candidatos más votados de cada consulta (porcentaje sobre el total global).</p>
      <div id="tablaConsultas"></div>
    </section>
  </main>

  <footer class="footer">
    <small>© 2026 · Ejercicio pedagógico sin validez oficial</small>
  </footer>

<script>
  /* ========= CONFIG ========= */
  const API_URL = "https://script.google.com/macros/s/AKfycbzrcOa_YqUlAyU9ECe99Bosk_VQttAOmB5l3oLy2dmeL0Cg9gTiHd133pxn0qsKd-MvJA/exec";

  /* ========= DATA ========= */
  const DATA = {
    records: [
      {name:"Claudia Nayibe López Hernández",slug:"claudia-nayibe-lopez-hernandez",photo:"assets/photo-claudia-nayibe-lopez-hernandez.png",logo:"assets/logo-claudia-nayibe-lopez-hernandez.png"},
      {name:"Leonardo Humberto Huerta Gutiérrez",slug:"leonardo-humberto-huerta-gutierrez",photo:"assets/photo-leonardo-humberto-huerta-gutierrez.png",logo:"assets/logo-leonardo-humberto-huerta-gutierrez.png"},
      {name:"Mauricio Cárdenas Santamaría",slug:"mauricio-cardenas-santamaria",photo:"assets/photo-mauricio-cardenas-santamaria.png",logo:"assets/logo-mauricio-cardenas-santamaria.png"},
      {name:"David Andrés Luna Sánchez",slug:"david-andres-luna-sanchez",photo:"assets/photo-david-andres-luna-sanchez.png",logo:"assets/logo-david-andres-luna-sanchez.png"},
      {name:"Victoria Eugenia Dávila Hoyos",slug:"victoria-eugenia-davila-hoyos",photo:"assets/photo-victoria-eugenia-davila-hoyos.png",logo:"assets/logo-victoria-eugenia-davila-hoyos.png"},
      {name:"Juan Manuel Galán Pachón",slug:"juan-manuel-galan-pachon",photo:"assets/photo-juan-manuel-galan-pachon.png",logo:"assets/logo-juan-manuel-galan-pachon.png"},
      {name:"Paloma Susana Valencia Laserna",slug:"paloma-susana-valencia-laserna",photo:"assets/photo-paloma-susana-valencia-laserna.png",logo:"assets/logo-paloma-susana-valencia-laserna.png"},
      {name:"Juan Carlos Pinzón Bueno",slug:"juan-carlos-pinzon-bueno",photo:"assets/photo-juan-carlos-pinzon-bueno.png",logo:"assets/logo-juan-carlos-pinzon-bueno.png"},
      {name:"Aníbal Gaviria Correa",slug:"anibal-gaviria-correa",photo:"assets/photo-anibal-gaviria-correa.png",logo:"assets/logo-anibal-gaviria-correa.png"},
      {name:"Enrique Peñalosa Londoño",slug:"enrique-penalosa-londono",photo:"assets/photo-enrique-penalosa-londono.png",logo:"assets/logo-enrique-penalosa-londono.png"},
      {name:"Juan Daniel Oviedo Arango",slug:"juan-daniel-oviedo-arango",photo:"assets/photo-juan-daniel-oviedo-arango.png",logo:"assets/logo-juan-daniel-oviedo-arango.png"},
      {name:"Héctor Elías Pineda Salazar",slug:"hector-elias-pineda-salazar",photo:"assets/photo-hector-elias-pineda-salazar.png",logo:"assets/logo-hector-elias-pineda-salazar.png"},
      {name:"Edison Lucio Torres Moreno",slug:"edison-lucio-torres-moreno",photo:"assets/photo-edison-lucio-torres-moreno.png",logo:"assets/logo-edison-lucio-torres-moreno.png"},
      {name:"Roy Leonardo Barreras Montealegre",slug:"roy-leonardo-barreras-montealegre",photo:"assets/photo-roy-leonardo-barreras-montealegre.png",logo:"assets/logo-roy-leonardo-barreras-montealegre.png"},
      {name:"Martha Viviana Bernal Amaya",slug:"martha-viviana-bernal-amaya",photo:"assets/photo-martha-viviana-bernal-amaya.png",logo:"assets/logo-martha-viviana-bernal-amaya.png"},
      {name:"Daniel Quintero Calle",slug:"daniel-quintero-calle",photo:"assets/photo-daniel-quintero-calle.png",logo:"assets/logo-daniel-quintero-calle.png"}
    ],
    consultas: [
      {title:"Consulta de las Soluciones",subtitle:"Salud, seguridad y educación",candidates:["claudia-nayibe-lopez-hernandez","leonardo-humberto-huerta-gutierrez"]},
      {title:"La Gran Consulta por Colombia",subtitle:"",candidates:["mauricio-cardenas-santamaria","david-andres-luna-sanchez","victoria-eugenia-davila-hoyos","juan-manuel-galan-pachon","paloma-susana-valencia-laserna","juan-carlos-pinzon-bueno","anibal-gaviria-correa","enrique-penalosa-londono","juan-daniel-oviedo-arango"]},
      {title:"Consulta del Frente por la Vida",subtitle:"",candidates:["hector-elias-pineda-salazar","edison-lucio-torres-moreno","roy-leonardo-barreras-montealegre","martha-viviana-bernal-amaya","daniel-quintero-calle"]}
    ]
  };

  /* ========= UTILS voto único ========= */
  const KEYS = { deviceId:'consulta_device_id_8m', hasVoted:'consulta_has_voted_8m' };
  function getCookie(name){ const m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)')); return m ? decodeURIComponent(m[1]) : null; }
  function setCookie(name, value, days=365){ document.cookie = `${name}=${encodeURIComponent(value)}; path=/; max-age=${days*24*60*60}`; }
  function getDeviceId(){ let id = localStorage.getItem(KEYS.deviceId) || getCookie('device_id_8m'); if(!id){ id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : 'dev-' + Math.random().toString(36).slice(2) + Date.now(); localStorage.setItem(KEYS.deviceId,id); setCookie('device_id_8m',id,365);} return id; }
  function hasVoted(){ return localStorage.getItem(KEYS.hasVoted)==='true'; }
  function markVoted(){ localStorage.setItem(KEYS.hasVoted,'true'); }
  function lockVotingUI(){ document.querySelectorAll('.tile').forEach(t=>{ t.classList.add('disabled'); t.style.pointerEvents='none'; }); }

  /* ========= Render del tarjetón ========= */
  const bySlug = Object.fromEntries(DATA.records.map(r => [r.slug, r]));

  function renderBallot(){
    const content = document.getElementById('content');
    if (!content) return;
    content.innerHTML = '';
    DATA.consultas.forEach((g, gidx) => {
      const sec = document.createElement('section');
      sec.className = 'consulta';
      const h = document.createElement('h2'); h.textContent = g.title; sec.appendChild(h);
      if (g.subtitle){ const p = document.createElement('p'); p.className='subtitle'; p.textContent=g.subtitle; sec.appendChild(p); }
      const grid = document.createElement('div'); grid.className='grid'; grid.setAttribute('role','radiogroup');

      g.candidates.forEach((slug, idx) => {
        const c = bySlug[slug]; if(!c) return;
        const tile = document.createElement('div');
        tile.className='tile'; tile.setAttribute('role','radio'); tile.setAttribute('aria-checked','false');
        tile.setAttribute('tabindex', (gidx===0 && idx===0) ? '0':'-1'); tile.dataset.slug = slug;
        tile.innerHTML = `
          <img class="photo" loading="lazy" src="${c.photo}" alt="Foto de ${c.name}">
          <div class="logo-wrap"><img class="logo" loading="lazy" src="${c.logo}" alt="Logo de ${c.name}"></div>
          <div class="name">${c.name}</div>
          <div class="xmark">X</div>`;
        tile.addEventListener('click', () => selectBySlug(slug));
        grid.appendChild(tile);
      });

      sec.appendChild(grid);
      document.getElementById('content').appendChild(sec);
    });

    if (hasVoted()) lockVotingUI();
  }

  // Envío silencioso del voto
  let lastSent = null;
  async function enviarRegistro(nombreCandidato, deviceId){
    try{
      await fetch(API_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ candidato:nombreCandidato, deviceId }) });
      lastSent = deviceId;
    }catch(e){ /* silencioso */ }
  }

  // Selección única + bloqueo por dispositivo
  function selectBySlug(slug){
    if (hasVoted()) return;
    document.querySelectorAll('.tile').forEach(t=>{ t.classList.remove('selected'); t.setAttribute('aria-checked','false'); });
    const chosen = document.querySelector(`.tile[data-slug="${slug}"]`);
    if(chosen){ chosen.classList.add('selected'); chosen.setAttribute('aria-checked','true'); }
    // marcar y bloquear
    markVoted(); lockVotingUI();
    // enviar
    const rec = bySlug[slug]; const name = rec ? rec.name : null;
    const deviceId = getDeviceId();
    if (name && lastSent !== deviceId) enviarRegistro(name, deviceId);
  }

  /* ========= Resultados globales: % por consulta + Top 2 candidatos (global %) ========= */
  const tablaConsultas = document.getElementById('tablaConsultas');

  async function fetchGlobalTotals(){
    try{
      const res = await fetch(API_URL + '?metrics=1', { cache:'no-store' });
      const data = await res.json(); // { total, candidates: {nombre: votos} }
      if (!data || typeof data.total!=='number' || !data.candidates) return;
      updateConsultasTable(data);
    }catch(e){ /* silencioso */ }
  }

  function updateConsultasTable(globalTotals){
    const total = globalTotals.total || 0;

    const rowsHtml = DATA.consultas.map(c => {
      const names = c.candidates.map(s => bySlug[s]?.name).filter(Boolean);
      // Votos de la consulta
      const votosConsulta = names.reduce((acc,n)=> acc + (globalTotals.candidates[n] || 0), 0);
      const pctConsulta = total>0 ? Math.round((votosConsulta/total)*100) : 0;

      // Top 2 candidatos de la consulta (por votos absolutos) y su % sobre total global
      const arr = names.map(n => ({ name:n, v:(globalTotals.candidates[n]||0) }))
                       .sort((a,b)=> b.v - a.v);
      const top1 = arr[0] && arr[0].v>0 ? arr[0] : null;
      const top2 = arr[1] && arr[1].v>0 ? arr[1] : null;
      const top1Pct = top1 ? Math.round((top1.v/total)*100) : 0;
      const top2Pct = top2 ? Math.round((top2.v/total)*100) : 0;

      const topHtml = (top1||top2) ? `
        <div class="top2">
          <span class="label">Candidatos más votados:</span>
          ${ top1 ? `<span class="pill">${top1.name} <span class="pct">${top1Pct}%</span></span>` : '' }
          ${ top2 ? `<span class="pill">${top2.name} <span class="pct">${top2Pct}%</span></span>` : '' }
        </div>` : `
        <div class="top2"><span class="label">Candidatos más votados:</span><span class="pill">—</span></div>`;

      return `
        <tr>
          <td class="t-left">${c.title}</td>
          <td class="t-right">${pctConsulta}%</td>
        </tr>
        <tr class="row-meter">
          <td colspan="2">
            <div class="meter meter--thin"><div class="meter__bar" style="width:${pctConsulta}%"></div></div>
          </td>
        </tr>
        <tr class="row-sub">
          <td colspan="2">${topHtml}</td>
        </tr>`;
    }).join('');

    tablaConsultas.innerHTML = `
      <table class="table">
        <thead>
          <tr><th class="t-left">Consulta</th><th class="t-right">%</th></tr>
        </thead>
        <tbody>
          ${ rowsHtml || '<tr><td colspan="2" class="muted t-left">Aún no hay votos globales.</td></tr>'}
        </tbody>
      </table>
    `;
  }

  // Init
  renderBallot();
  fetchGlobalTotals();
  setInterval(fetchGlobalTotals, 7000);
</script>
</body>
</html>
